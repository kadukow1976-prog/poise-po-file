<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Поиск файлов — УграРемКомп</title>
<meta name="color-scheme" content="light dark" />
<style>
:root{
  --bg:#0b1220; --panel:#0f172a; --muted:#93a3b8; --text:#e5e7eb; --border:#1e293b;
  --accent:#16a34a; --accent2:#22c55e; --chip:#0b3d24;
}
@media (prefers-color-scheme: light){
  :root{ --bg:#f6f7f9; --panel:#ffffff; --muted:#6b7280; --text:#111827; --border:#e5e7eb; --chip:#e8f7ee; }
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}
.app{min-height:100%;display:flex;flex-direction:column}
.container{width:100%;max-width:1100px;margin:0 auto;padding:24px 16px 48px}

/* Топбар */
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
h1{font-size:28px;margin:0;font-weight:800;letter-spacing:.2px}
.ghost-btn{background:transparent;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.ghost-btn:hover{border-color:var(--muted)}

/* Поиск */
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
.search-row{display:flex;gap:10px;flex-wrap:wrap}
.input{flex:1 1 320px;min-width:200px;padding:14px 16px;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:12px;outline:none}
.btn{background:#111827;color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
.btn:hover{background:var(--accent)}
.help{margin:10px 0 0;color:var(--muted);font-size:14px}

/* Таблица */
.table{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-top:14px}
.thead,.trow{display:grid;grid-template-columns:1fr 120px 120px 90px;align-items:center}
.thead{background:color-mix(in oklab, var(--panel), white 6%);border-bottom:1px solid var(--border);padding:12px 14px;font-weight:800}
.trow{padding:12px 14px;border-top:1px solid var(--border)}
.title{font-weight:700;word-break:break-word}
.tags{color:var(--muted);font-size:12px;margin-top:4px}
.size{white-space:nowrap}
.open{display:inline-block;background:#111827;color:#fff;text-decoration:none;border-radius:10px;padding:8px 12px;font-weight:800}
.open:hover{background:var(--accent)}
.empty{padding:14px;color:var(--muted);display:none}
.pager{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-top:1px solid var(--border)}
.meta{margin:10px 2px 0;color:var(--muted)}
mark{background:var(--chip);color:inherit;padding:0 2px;border-radius:3px}

/* Мобилка */
.hide-sm{display:block}
.show-sm{display:none}
.inline{display:none}
@media (max-width:700px){
  .thead{display:none}
  .trow{grid-template-columns:1fr auto;gap:12px}
  .hide-sm{display:none}
  .show-sm{display:inline-block}
  .inline{display:flex;gap:12px;color:var(--muted);font-size:12px;margin-top:6px}
  .inline .clicks::before{content:"Клики: "}
}

/* Лоадер */
.loader{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:14px}
.loader:before{content:"";width:14px;height:14px;border-radius:50%;border:2px solid var(--muted);border-top-color:transparent;display:inline-block;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Экран пароля */
#lock{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:10}
.lock-box{background:var(--panel);border:1px solid var(--border);padding:28px;border-radius:14px;width:min(380px,90%);box-shadow:0 10px 30px rgba(0,0,0,.25)}
.lock-box h3{margin:0 0 10px;font-size:20px}
.lock-input{width:100%;padding:12px 14px;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:10px}
.lock-btn{margin-top:10px;width:100%}
.err{color:#ef4444;font-size:14px;margin-top:10px;display:none}
</style>
</head>
<body>
<div class="app">

  <!-- Экран пароля -->
  <div id="lock">
    <div class="lock-box">
      <h3>Введите пароль</h3>
      <input id="pass" class="lock-input" type="password" placeholder="Пароль" />
      <button id="loginBtn" class="btn lock-btn" type="button">Войти</button>
      <div id="err" class="err">Неверный пароль</div>
    </div>
  </div>

  <!-- Приложение -->
  <main id="app" style="display:none">
    <div class="container">
      <div class="topbar">
        <h1>Найти файл</h1>
        <button id="logout" class="ghost-btn" type="button">Выйти</button>
      </div>

      <section class="card">
        <div class="search-row">
          <input id="q" class="input" type="search" placeholder="Например: драйвер, прошивка, инструкция…" />
          <button id="showAll" class="btn" type="button">Показать всё</button>
        </div>
        <p class="help">Минимум 2 буквы для поиска. «Показать всё» — выведет весь список.</p>
      </section>

      <section class="table">
        <div class="thead">
          <div>Файл</div><div>Размер</div><div>Открыть</div><div>Клики</div>
        </div>
        <div id="rows"></div>
        <div id="empty" class="empty">Ничего не найдено</div>
        <div id="pager" class="pager">
          <button id="prev" class="ghost-btn" disabled>Назад</button>
          <div id="pageInfo">Стр. 1/1</div>
          <button id="next" class="ghost-btn" disabled>Вперёд</button>
        </div>
      </section>

      <p id="meta" class="meta loader">Загружается…</p>
    </div>
  </main>
</div>

<script>
/* ==== НАСТРОЙКИ ==== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGL9aeAC7JASDu24QmYMDUpkEwbAfB5977LMJ_FBPUoARUo7IBS_z3x4f2xqW8t7_Df6E3apLRwXS7/pub?gid=0&single=true&output=csv";
const PASS_HASH_HEX = "b69a9ff34e8b29b89c2b3e93ef019b74a0fa43d9f589265bcffdc7a0469a6f29"; // пароль "a1980"
const PAGE_SIZE = 20;
const ACCESS_KEY = "fs_access_ok_v1";
/* =================== */

const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const lock=$("#lock"), app=$("#app"), err=$("#err");
const pass=$("#pass"), loginBtn=$("#loginBtn"), logout=$("#logout");
const rows=$("#rows"), meta=$("#meta"), q=$("#q"), showAll=$("#showAll"), prev=$("#prev"), next=$("#next"), pageInfo=$("#pageInfo"), empty=$("#empty");

let unlocked=sessionStorage.getItem(ACCESS_KEY)==="1";
let DATA=[], FILTERED=[], page=1, _loaded=false;

/* Вспомогательные функции */
const norm=s=>(s||"").toLowerCase().normalize("NFKD").replace(/[ё]/g,"е").replace(/[\u0300-\u036f]/g,"").trim();
const esc=s=>(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
const mark=(txt,q)=>!q?esc(txt):esc(txt).replace(new RegExp("("+q.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\$&")+")","ig"),"<mark>$1</mark>");

function splitCSVLine(line,d){const o=[];let c="",q=false;for(let i=0;i<line.length;i++){const ch=line[i],n=line[i+1];if(ch=='"'){if(q&&n=='"'){c+='"';i++;}else q=!q;}else if(ch==d&&!q){o.push(c);c="";}else c+=ch;}o.push(c);return o;}
function parseCSV(txt){const lines=txt.replace(/\r/g,"").split("\n").filter(x=>x.trim());if(!lines.length)return[];const d=(lines[0].match(/;/g)||[]).length>(lines[0].match(/,/g)||[]).length?";":",";const head=splitCSVLine(lines[0],d).map(norm);return lines.slice(1).map(l=>{const c=splitCSVLine(l,d),o={};head.forEach((h,i)=>o[h]=c[i]??"");return o;});}
function mapRow(r){const g=k=>r[k]??r[k?.toLowerCase?.()]??"";return{name:g("name")||g("название")||g("file")||g("файл"),url:g("url")||g("ссылка")||g("link"),size:g("size")||g("размер"),tags:g("tags")||g("теги"),desc:g("desc")||g("описание")};}

/* Хэш */
async function sha256(str){const b=new TextEncoder().encode(str);const h=await crypto.subtle.digest("SHA-256",b);return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,"0")).join("");}

/* Рендер */
function render(list,qstr){const clicks=JSON.parse(localStorage.getItem("clicks")||"{}");rows.innerHTML=list.map(r=>{const a=mapRow(r),title=a.desc?`${a.name} — ${a.desc}`:a.name;const cnt=clicks[a.url]||0;return `<div class='trow'><div><div class='title'>${mark(title,qstr)}</div>${a.tags?`<div class='tags'>#${esc(a.tags)}</div>`:""}</div><div class='size hide-sm'>${esc(a.size||"—")}</div><div class='hide-sm'>${a.url?`<a class='open' href='${a.url}' target='_blank' data-url='${a.url}'>Открыть</a>`:"—"}</div><div class='hide-sm' data-clicks-for='${a.url}'>${cnt}</div></div>`;}).join("");meta.classList.remove("loader");meta.textContent=`Всего: ${DATA.length}, найдено: ${list.length}`;}
function parseAndRender(txt){DATA=parseCSV(txt);render(DATA,"");}

/* Загрузка CSV */
async function load(){if(_loaded)return;try{const r=await fetch(CSV_URL,{cache:"no-store"});const t=await r.text();parseAndRender(t);_loaded=true;}catch(e){rows.innerHTML=`<div style='padding:12px;color:#f00'>Ошибка: ${e}</div>`;}}

/* Логика входа */
loginBtn.onclick=async()=>{const val=pass.value;const hash=await sha256(val);if(hash===PASS_HASH_HEX){unlocked=true;sessionStorage.setItem(ACCESS_KEY,"1");lock.style.display="none";app.style.display="block";load();}else{err.style.display="block";setTimeout(()=>err.style.display="none",2000);}};
logout.onclick=()=>{unlocked=false;sessionStorage.removeItem(ACCESS_KEY);app.style.display="none";lock.style.display="flex";};

/* Поиск */
q.oninput=()=>{const v=q.value.trim();if(v.length<2){rows.innerHTML="";meta.textContent="";return;}const n=norm(v);const res=DATA.filter(r=>{const a=mapRow(r);return[a.name,a.desc,a.tags].map(norm).join(" ").includes(n)});render(res,v);};
showAll.onclick=()=>render(DATA,"");

/* Старт */
if(unlocked){lock.style.display="none";app.style.display="block";load();}
</script>
</body>
</html>
